#!/usr/bin/env bash
set -eu

. "$(dirname "${BASH_SOURCE[0]}")/setup"

if [[ "${1:-}" == "help" ]]; then
  echo "list"
  echo ""
  echo "List installed libraries:"
  echo "- in the DATA_DIR and the CACHE_DIR"
  echo "- under the @local, @preview or other prefixes"
  echo "- all their versions"
  echo ""
  echo "Local package prefix: $DATA_DIR/typst/package/local"
  echo "Local preview package prefix: $DATA_DIR/typst/package/preview"
  exit 1
fi

get_subfolders() {
  for subfolder in $(find $1 -maxdepth 1 -mindepth 1 -type d); do
    echo "$(basename ${subfolder})"
  done
}

list_libraries() {
  prefixes=$(get_subfolders $1)
  if [ -n "$prefixes" ]; then
    for prefix in $prefixes; do
      libraries=$(get_subfolders $1/$prefix)
      if [ -n "$libraries" ]; then
        for library in $libraries; do
          versions=$(get_subfolders $1/$prefix/$library)
          if [ -n "$libraries" ]; then
            for version in $versions; do
              echo -e "  \e]8;;file://$1/$prefix/$library/$version/\e\\@$prefix/$library:$version\e]8;;\e\\"
            done
          fi
        done
      fi
    done
  fi
}

# Start with the data directory, which have precedence over the cache directory
echo "In $DATA_DIR/typst/packages/"
list_libraries $DATA_DIR/typst/packages/
# Then the cache directory, used by on-demand downloads with the Typst compiler
echo "In $CACHE_DIR/typst/packages/"
list_libraries $CACHE_DIR/typst/packages/